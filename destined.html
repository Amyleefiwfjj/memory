<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <title>한글 획수 궁합 – 연결만</title>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.2/lib/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: system-ui
        }

        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10
        }

        input,
        button {
            padding: 4px 8px;
            margin-right: 4px;
            font-size: 16px
        }

        #score {
            font-weight: bold;
            font-size: 18px;
            margin-left: 12px
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1
        }
    </style>
</head>

<body>
    <div id="ui">
        <input id="nameA" placeholder="이름1" value="홍길동">
        <input id="nameB" placeholder="이름2" value="김미미">
        <button id="runBtn">시각화</button>
        <span id="score"></span>
    </div>

    <script>
        // ── 1. 획수 테이블 & 분해 맵 ──
        const strokeMap = {
            'ㄱ': 2, 'ㄴ': 2, 'ㄷ': 3, 'ㄹ': 5, 'ㅁ': 4, 'ㅂ': 4, 'ㅅ': 2, 'ㅇ': 1, 'ㅈ': 3, 'ㅊ': 4, 'ㅋ': 3, 'ㅌ': 4, 'ㅍ': 4, 'ㅎ': 3,
            'ㅏ': 2, 'ㅐ': 3, 'ㅑ': 3, 'ㅒ': 4, 'ㅓ': 2, 'ㅔ': 3, 'ㅕ': 3, 'ㅖ': 4, 'ㅗ': 2, 'ㅛ': 3, 'ㅜ': 2, 'ㅠ': 3, 'ㅡ': 1, 'ㅣ': 1
        };
        const splitCon = {
            'ㄲ': ['ㄱ', 'ㄱ'], 'ㄳ': ['ㄱ', 'ㅅ'], 'ㄵ': ['ㄴ', 'ㅈ'], 'ㄶ': ['ㄴ', 'ㅎ'],
            'ㄺ': ['ㄹ', 'ㄱ'], 'ㄻ': ['ㄹ', 'ㅁ'], 'ㄼ': ['ㄹ', 'ㅂ'], 'ㄽ': ['ㄹ', 'ㅅ'],
            'ㄾ': ['ㄹ', 'ㅌ'], 'ㄿ': ['ㄹ', 'ㅍ'], 'ㅀ': ['ㄹ', 'ㅎ'], 'ㅄ': ['ㅂ', 'ㅅ'],
            'ㄸ': ['ㄷ', 'ㄷ'], 'ㅃ': ['ㅂ', 'ㅂ'], 'ㅆ': ['ㅅ', 'ㅅ'], 'ㅉ': ['ㅈ', 'ㅈ']
        };
        const splitVow = {
            'ㅘ': ['ㅗ', 'ㅏ'], 'ㅙ': ['ㅗ', 'ㅐ'], 'ㅚ': ['ㅗ', 'ㅣ'],
            'ㅝ': ['ㅜ', 'ㅓ'], 'ㅞ': ['ㅜ', 'ㅔ'], 'ㅟ': ['ㅜ', 'ㅣ'], 'ㅢ': ['ㅡ', 'ㅣ']
        };
        const CHO = ['ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
        const JUNG = ['ㅏ', 'ㅐ', 'ㅑ', 'ㅒ', 'ㅓ', 'ㅔ', 'ㅕ', 'ㅖ', 'ㅗ', 'ㅘ', 'ㅙ', 'ㅚ', 'ㅛ', 'ㅜ', 'ㅠ', 'ㅝ', 'ㅞ', 'ㅟ', 'ㅠ', 'ㅡ', 'ㅢ', 'ㅣ'];
        const JONG = ['', 'ㄱ', 'ㄲ', 'ㄳ', 'ㄴ', 'ㄵ', 'ㄶ', 'ㄷ', 'ㄹ', 'ㄺ', 'ㄻ', 'ㄼ', 'ㄽ', 'ㄾ', 'ㄿ', 'ㅀ', 'ㅁ', 'ㅂ', 'ㅄ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];

        // ── 2. 한글 음절 분해 → 자모 배열
        function decomposeHangul(str) {
            return Array.from(str).map(ch => {
                const code = ch.charCodeAt(0) - 0xAC00;
                if (code < 0 || code > 11171) return [ch];
                const jong = code % 28;
                const jung = Math.floor((code / 28) % 21);
                const cho = Math.floor(code / (28 * 21));
                const parts = [CHO[cho], JUNG[jung]];
                if (JONG[jong]) parts.push(JONG[jong]);
                return parts;
            });
        }

        // ── 3. 음절별 획수 합산
        function countStrokes(str) {
            return decomposeHangul(str).map(parts =>
                parts
                    .flatMap(j => splitCon[j] || splitVow[j] || [j])
                    .reduce((sum, jamo) => sum + (strokeMap[jamo] || 0), 0)
            );
        }

        // ── 4. 두 이름 글자 교차 삽입
        function interleave(a, b) {
            const out = [], n = Math.max(a.length, b.length);
            for (let i = 0; i < n; i++) {
                if (i < a.length) out.push(a[i]);
                if (i < b.length) out.push(b[i]);
            }
            return out;
        }

        // ── 5. 슬라이딩(pairwise adjacent) 합산 (mod 10)
        function combine(scores) {
            const next = [];
            for (let i = 0; i < scores.length - 1; i++) {
                next.push((scores[i] + scores[i + 1]) % 10);
            }
            return next;
        }

        // ── 6. 모든 단계 계산 후 배열로 반환
        function calcSteps(name1, name2) {
            const chars = interleave(name1, name2);
            const steps = [];
            let current = countStrokes(chars.join(''));
            steps.push(current);
            while (current.length > 1) {
                current = combine(current);
                steps.push(current);
            }
            return steps;
        }

        // ── 7. p5.js 시각화
        let vizSteps = [];
        function setup() {
            createCanvas(windowWidth, windowHeight);
            noLoop();
            textAlign(CENTER, CENTER);
            textSize(24);
        }
        function draw() {
            clear();
            if (!vizSteps.length) return;
            const Mx = 100, ColW = 120, Vs = 80;
            for (let i = 0; i < vizSteps.length; i++) {
                const arr = vizSteps[i];
                const x = Mx + i * ColW;
                const totalH = (arr.length - 1) * Vs;

                // 숫자만 그리기
                noStroke(); fill(0);
                arr.forEach((v, j) => {
                    const y = height / 2 - totalH / 2 + j * Vs;
                    text(v, x, y);
                });

                // 연결선만 그리기
                if (i < vizSteps.length - 1) {
                    stroke(0);
                    const next = vizSteps[i + 1];
                    const nextH = (next.length - 1) * Vs;
                    next.forEach((_, k) => {
                        const x2 = Mx + (i + 1) * ColW;
                        const y2 = height / 2 - nextH / 2 + k * Vs;
                        const y1a = height / 2 - totalH / 2 + k * Vs;
                        const y1b = height / 2 - totalH / 2 + (k + 1) * Vs;
                        line(x, y1a, x2, y2);
                        line(x, y1b, x2, y2);
                    });
                }
            }
        }

        window.addEventListener('resize', () => {
            resizeCanvas(windowWidth, windowHeight);
            redraw();
        });

        // ── 8. 버튼 클릭 핸들러
        document.getElementById('runBtn').addEventListener('click', () => {
            const A = document.getElementById('nameA').value.trim();
            const B = document.getElementById('nameB').value.trim();
            if (!A || !B) return;
            vizSteps = calcSteps(A, B);

            // 요약 문자열 표시
            const txt = vizSteps
                .map((arr, i) =>
                    i < vizSteps.length - 1 ? arr.join(',') : arr.join('')
                ).join(' → ');
            document.getElementById('score').textContent = txt;

            redraw();
        });
    </script>
</body>

</html>